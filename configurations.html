import os
from flask import Blueprint, render_template, request, redirect, url_for, flash
from dynamic_funcs import DYNAMIC_FUNCTIONS
from alerts.utils import list_alert_files
from .utils import load_configurations, save_configurations

bp = Blueprint("configurations", __name__, template_folder="../templates")

@bp.route("/configurations")
def list_configurations():
    configs = load_configurations()
    return render_template("configurations.html", configurations=configs)

@bp.route("/configurations/new", methods=["GET", "POST"])
def new_configuration():
    if request.method == "POST":
        key = request.form["config_key"].strip()
        data = {}
        keys = request.form.getlist("key")
        types = request.form.getlist("type")
        statics = request.form.getlist("value_static")
        dynamics = request.form.getlist("value_dynamic")
        alerts = request.form.getlist("value_alert")

        for k, t, s, d, a in zip(keys, types, statics, dynamics, alerts):
            if not k:
                continue
            if t == "static":
                data[k] = {"type": "static", "value": s}
            elif t == "dynamic":
                data[k] = {"type": "dynamic", "value": d}
            elif t == "dynamicallypickfrom":
                data[k] = {"type": "dynamicallypickfrom", "value": a}

        configs = load_configurations()
        configs[key] = data
        save_configurations(configs)
        flash(f"Configuration '{key}' created!", "success")
        return redirect(url_for("configurations.list_configurations"))

    return render_template(
        "create_configuration.html",
        dynamic_funcs=list(DYNAMIC_FUNCTIONS.keys()),
        alert_files=list_alert_files()
    )

@bp.route("/configurations/edit/<name>", methods=["GET", "POST"])
def edit_configuration(name):
    configs = load_configurations()
    if name not in configs:
        flash("Configuration not found", "error")
        return redirect(url_for("configurations.list_configurations"))

    if request.method == "POST":
        data = {}
        keys = request.form.getlist("key")
        types = request.form.getlist("type")
        statics = request.form.getlist("value_static")
        dynamics = request.form.getlist("value_dynamic")
        alerts = request.form.getlist("value_alert")

        for k, t, s, d, a in zip(keys, types, statics, dynamics, alerts):
            if not k:
                continue
            if t == "static":
                data[k] = {"type": "static", "value": s}
            elif t == "dynamic":
                data[k] = {"type": "dynamic", "value": d}
            elif t == "dynamicallypickfrom":
                data[k] = {"type": "dynamicallypickfrom", "value": a}

        configs[name] = data
        save_configurations(configs)
        flash(f"Configuration '{name}' updated!", "success")
        return redirect(url_for("configurations.list_configurations"))

    return render_template(
        "edit_configuration.html",
        name=name,
        placeholders=configs[name],
        dynamic_funcs=list(DYNAMIC_FUNCTIONS.keys()),
        alert_files=list_alert_files()
    )

@bp.route("/configurations/delete/<name>", methods=["POST"])
def delete_configuration(name):
    configs = load_configurations()
    if name in configs:
        del configs[name]
        save_configurations(configs)
        flash(f"Configuration '{name}' deleted!", "success")
    else:
        flash("Configuration not found", "error")
    return redirect(url_for("configurations.list_configurations"))
